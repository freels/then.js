/*!
  * Then: Flexible, composable, monadic futures for javascript
  * (c) Matt Freels 2012
  * https://github.com/freels/then.js
  * license MIT
  *//*global define:false, module:false */
!function(a,b){typeof define=="function"?define(b):typeof module!="undefined"?module.exports=b():this[a]=b()}("then",function(){function a(){this.message=".update called multiple times for this Promise."}function b(a){this.isTimeout=!0,this.message="Timed out after "+a+"ms."}function c(a){for(var b=0;b<a.callbacks.length;b++)a.callbacks[b](a.error,a.value);a.callbacks=[]}function d(a){!!a&&a.isFuture}function e(a,b,c){a||!d(b)?c.update(a,b):b.onUpdate(function(a,b){e(a,b,c)})}function f(){if(arguments.length===0)return new g;var a=arguments[0],b=Array.prototype.slice.call(arguments,1),c=new g;return a.apply(null,b.concat(c)),c}function g(){this.isDefined=!1,this.isError=!1,this.value=null,this.error=null,this.callbacks=[]}return a.prototype=new Error,b.prototype=new Error,g.prototype={isFuture:!0,update:function(b,c){if(!this.updateIfEmpty(b,c))throw new a},updateIfEmpty:function(a,b){return this.isDefined?!1:(this.error=a,this.value=b,this.isDefined=!0,c(this),!0)},setValue:function(a){this.update(null,a)},setError:function(a){this.update(a,null)},onUpdate:function(a){return this.isDefined?a(this.error,this.value):this.callbacks.push(a),this},onSuccess:function(a){return this.onUpdate(function(b,c){c!==null&&a(c)})},onError:function(a){return this.onUpdate(function(b,c){b!==null&&a(b)})},respond:function(a){var b=new g;return this.onUpdate(function(d,f){try{var g=a(d,f);e(g[0],g[1],b)}catch(h){b.setError(h)}}),b},then:function(a){return this.respond(function(b,c){return b?[b,null]:[null,a(c)]})},rescue:function(a){return this.respond(function(b,c){return b?[null,a(b)]:[null,c]})},ensure:function(a){return this.respond(function(b,c){return a(),[b,c]})},within:function(a){var c=new g,d=setTimeout(function(){c.updateIfEmpty(new b(a),null)},a);return this.onUpdate(function(a,b){clearTimeout(d),c.updateIfEmpty(a,b)}),c}},f})